<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Team AWA Tracker — EUW</title>
<link rel="icon" href="data:,">
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:ital,wght@0,400;0,500;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg:      #080b0f;
  --bg2:     #0d1117;
  --bg3:     #141b23;
  --border:  #1c2630;
  --gold:    #c89b3c;
  --gold2:   #f0ce71;
  --silver:  #9ab0c0;
  --silver2: #c8dce8;
  --bronze:  #cd7f32;
  --bronze2: #e8a050;
  --blue:    #4a90d9;
  --red:     #d9534a;
  --green:   #4ad97a;
  --text:    #cccbc4;
  --muted:   #58677a;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}
body::before {
  content: '';
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background:
    radial-gradient(ellipse 70% 35% at 50% -5%, rgba(74,144,217,.1) 0%, transparent 60%),
    radial-gradient(ellipse 50% 25% at 85% 90%, rgba(200,155,60,.07) 0%, transparent 55%);
}
body::after {
  content: '';
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  opacity: .025;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
  background-size: 128px;
}

.wrapper {
  position: relative; z-index: 1;
  max-width: 1100px; margin: 0 auto; padding: 0 28px 100px;
}

/* ── HEADER ── */
header {
  display: flex; align-items: flex-end; justify-content: space-between;
  padding: 36px 0 24px;
  border-bottom: none; margin-bottom: 0;
}
.logo-block { display: flex; flex-direction: column; gap: 4px; }
.logo-eyebrow {
  font-family: 'DM Mono', monospace;
  font-size: .65rem; letter-spacing: 3px; text-transform: uppercase;
  color: var(--gold); opacity: .8;
}
.logo-title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 3rem; letter-spacing: 3px; line-height: 1;
  color: var(--gold2);
  text-shadow: 0 0 40px rgba(200,155,60,.35);
}
.header-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
.live-dot {
  display: flex; align-items: center; gap: 7px;
  font-family: 'DM Mono', monospace; font-size: .68rem; color: var(--muted);
}
.dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--green); box-shadow: 0 0 8px var(--green);
  animation: blink 2.2s ease-in-out infinite;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }
#countdown { font-family: 'DM Mono', monospace; font-size: .68rem; color: var(--muted); }

.btn-refresh, .btn-matches {
  background: none; border: 1px solid var(--border);
  color: var(--muted); font-family: 'DM Mono', monospace;
  font-size: .72rem; padding: 7px 16px; border-radius: 6px;
  cursor: pointer; transition: all .2s; margin-top: 4px;
}
.btn-refresh:hover  { border-color: var(--gold); color: var(--gold); }
.btn-matches:hover  { border-color: var(--blue); color: var(--blue); }
.btn-refresh:disabled, .btn-matches:disabled { opacity: .35; cursor: not-allowed; }

/* ── STATUS BAR ── */
#status-bar {
  font-family: 'DM Mono', monospace; font-size: .68rem;
  color: var(--muted); margin-bottom: 0;
  display: flex; align-items: center; gap: 10px;
}
.status-line { flex: 1; height: 1px; background: var(--border); }

/* ════════════════════════════════════
   PODIUM
════════════════════════════════════ */
#podium {
  display: flex;
  align-items: flex-start;
  justify-content: center;
  gap: 16px;
  margin-bottom: 0;
}

.podium-card {
  border-radius: 16px;
  padding: 24px 20px 20px;
  position: relative; overflow: hidden;
  display: flex; flex-direction: column; align-items: center;
  text-align: center;
  transition: transform .25s;
  animation: riseUp .6s ease both;
  flex-shrink: 0;
}
.podium-card:hover { transform: translateY(-4px); }
@keyframes riseUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:none} }

.podium-card.in-game::after {
  content: '';
  position: absolute; top: 0; left: -100%; width: 60%; height: 2px;
  background: linear-gradient(90deg, transparent, var(--blue), transparent);
  animation: shimmer-bar 2.5s linear infinite;
}
@keyframes shimmer-bar { to{left:160%} }

.podium-card.p1 {
  width: 300px; order: 2;
  background: linear-gradient(160deg, #1a1408 0%, #0f0d08 60%, #0a0c10 100%);
  border: 1px solid rgba(200,155,60,.5);
  box-shadow: 0 0 40px rgba(200,155,60,.12), 0 0 80px rgba(200,155,60,.05);
}
.podium-card.p1::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--gold), var(--gold2), var(--gold), transparent);
}
.podium-card.p2 {
  width: 250px; order: 1; margin-top: 48px;
  background: linear-gradient(160deg, #111518 0%, #0d1117 100%);
  border: 1px solid rgba(154,176,192,.35);
  box-shadow: 0 0 30px rgba(154,176,192,.07);
}
.podium-card.p2::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--silver), var(--silver2), var(--silver), transparent);
}
.podium-card.p3 {
  width: 250px; order: 3; margin-top: 48px;
  background: linear-gradient(160deg, #130e08 0%, #0d1117 100%);
  border: 1px solid rgba(205,127,50,.35);
  box-shadow: 0 0 30px rgba(205,127,50,.07);
}
.podium-card.p3::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--bronze), var(--bronze2), var(--bronze), transparent);
}

.medal {
  font-family: 'Bebas Neue', sans-serif; font-size: .75rem; letter-spacing: 2px;
  padding: 3px 10px; border-radius: 20px; margin-bottom: 16px;
}
.p1 .medal { color: var(--gold2);   background: rgba(200,155,60,.15); border: 1px solid rgba(200,155,60,.3); }
.p2 .medal { color: var(--silver2); background: rgba(154,176,192,.1); border: 1px solid rgba(154,176,192,.25); }
.p3 .medal { color: var(--bronze2); background: rgba(205,127,50,.1);  border: 1px solid rgba(205,127,50,.25); }

.p-avatar-ring { border-radius: 50%; padding: 3px; position: relative; margin-bottom: 14px; }
.p1 .p-avatar-ring { background: linear-gradient(135deg, var(--gold2), var(--gold), transparent); width: 88px; height: 88px; }
.p2 .p-avatar-ring { background: linear-gradient(135deg, var(--silver2), var(--silver), transparent); width: 72px; height: 72px; }
.p3 .p-avatar-ring { background: linear-gradient(135deg, var(--bronze2), var(--bronze), transparent); width: 72px; height: 72px; }
.p-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; display: block; background: var(--bg3); }
.p-lvl {
  position: absolute; bottom: -3px; left: 50%; transform: translateX(-50%);
  background: var(--bg3); border: 1px solid var(--border);
  font-family: 'DM Mono', monospace; font-size: .58rem;
  padding: 1px 6px; border-radius: 3px; color: var(--muted); white-space: nowrap;
}
.p-name { font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px; line-height: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
.p1 .p-name { font-size: 1.5rem; color: var(--gold2); }
.p2 .p-name, .p3 .p-name { font-size: 1.2rem; color: var(--text); }
.p-tag { font-family: 'DM Mono', monospace; font-size: .65rem; color: var(--muted); margin-top: 3px; margin-bottom: 14px; }
.p-rank { font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px; line-height: 1; margin-bottom: 4px; }
.p1 .p-rank { font-size: 1.6rem; }
.p2 .p-rank, .p3 .p-rank { font-size: 1.3rem; }
.p-lp { font-family: 'DM Mono', monospace; font-size: .65rem; color: var(--muted); margin-bottom: 4px; }
.p-wr { font-family: 'DM Mono', monospace; font-size: .65rem; }
.p-ingame { margin-top: 12px; font-family: 'DM Mono', monospace; font-size: .6rem; padding: 3px 9px; border-radius: 20px; }
.p-ingame.live { background: rgba(74,144,217,.12); color: var(--blue); border: 1px solid rgba(74,144,217,.4); }
.p-ingame.idle { background: var(--bg3); color: var(--muted); border: 1px solid var(--border); }

.p-matches { display: flex; gap: 5px; margin-top: 12px; justify-content: center; }
.p-match-cell { display: flex; flex-direction: column; align-items: center; gap: 2px; width: 36px; }
.p-match-strip { width: 100%; height: 3px; border-radius: 2px; }
.p-match-strip.w { background: var(--green); }
.p-match-strip.l { background: var(--red); }
.p-match-champ { font-family: 'DM Mono', monospace; font-size: .5rem; color: var(--muted); text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }
.p-match-kda { font-family: 'DM Mono', monospace; font-size: .5rem; text-align: center; }
.p-match-kda.w { color: var(--green); }
.p-match-kda.l { color: var(--red); }

/* ── NEW MATCH GLOW ── */
.p-match-strip.is-new  { box-shadow: 0 0 5px var(--green); }
.list-match-strip.is-new { box-shadow: 0 0 5px var(--green); }

/* ════════════════════════════════════
   LIST
════════════════════════════════════ */
.list-label {
  font-family: 'DM Mono', monospace; font-size: .65rem;
  text-transform: uppercase; letter-spacing: 3px;
  color: var(--muted); margin-bottom: 14px;
}
#list { display: flex; flex-direction: column; gap: 10px; }

.list-row {
  background: var(--bg2); border: 1px solid var(--border); border-radius: 12px;
  padding: 14px 18px; display: flex; align-items: center; gap: 16px;
  transition: border-color .25s, transform .2s;
  animation: slideUp .4s ease both; position: relative; overflow: hidden;
}
@keyframes slideUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:none} }
.list-row:hover { border-color: rgba(200,155,60,.3); transform: translateX(3px); }
.list-row.in-game { border-color: rgba(74,144,217,.4); }
.list-row.in-game::after {
  content: ''; position: absolute; top: 0; left: -100%; width: 60%; height: 2px;
  background: linear-gradient(90deg, transparent, var(--blue), transparent);
  animation: shimmer-bar 2.5s linear infinite;
}
.list-pos { font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; color: var(--muted); letter-spacing: 1px; width: 28px; text-align: center; flex-shrink: 0; }
.list-avatar-wrap { position: relative; flex-shrink: 0; }
.list-avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); background: var(--bg3); }
.list-lvl {
  position: absolute; bottom: -3px; left: 50%; transform: translateX(-50%);
  background: var(--bg3); border: 1px solid var(--border);
  font-family: 'DM Mono', monospace; font-size: .52rem;
  padding: 1px 4px; border-radius: 3px; color: var(--muted); white-space: nowrap;
}
.list-name-block { min-width: 0; flex: 1; }
.list-name { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 1px; line-height: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.list-tag  { font-family: 'DM Mono', monospace; font-size: .62rem; color: var(--muted); }
.list-rank-block { text-align: right; flex-shrink: 0; }
.list-tier { font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: .5px; }
.list-lp   { font-family: 'DM Mono', monospace; font-size: .62rem; color: var(--muted); }
.list-wr   { font-family: 'DM Mono', monospace; font-size: .62rem; }
.list-matches { display: flex; gap: 4px; flex-shrink: 0; }
.list-match-pip { display: flex; flex-direction: column; align-items: center; gap: 2px; width: 32px; }
.list-match-strip { width: 100%; height: 3px; border-radius: 2px; }
.list-match-strip.w { background: var(--green); }
.list-match-strip.l { background: var(--red); }
.list-match-champ { font-family: 'DM Mono', monospace; font-size: .48rem; color: var(--muted); text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
.list-ingame { font-family: 'DM Mono', monospace; font-size: .58rem; padding: 3px 8px; border-radius: 20px; flex-shrink: 0; }
.list-ingame.live { background: rgba(74,144,217,.12); color: var(--blue); border: 1px solid rgba(74,144,217,.4); }
.list-ingame.idle { background: var(--bg3); color: var(--muted); border: 1px solid var(--border); }

/* tier colors */
.t-iron        { color: #9e9e9e; }
.t-bronze      { color: #cd7f32; }
.t-silver      { color: #9ab0c0; }
.t-gold        { color: var(--gold); }
.t-platinum    { color: #3dc0a0; }
.t-emerald     { color: #50c878; }
.t-diamond     { color: #9ab8ff; }
.t-master      { color: #d080ff; }
.t-grandmaster { color: #ff6644; }
.t-challenger  { color: var(--gold2); text-shadow: 0 0 12px rgba(240,206,113,.5); }
.t-unranked    { color: var(--muted); }
.wr-w { color: var(--green); }
.wr-l { color: var(--red); }

.skel {
  background: linear-gradient(90deg, var(--bg2) 25%, var(--bg3) 50%, var(--bg2) 75%);
  background-size: 200% 100%; animation: skimmer 1.5s infinite; border-radius: 6px;
}
@keyframes skimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

#toast {
  position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%);
  background: var(--bg3); border: 1px solid var(--border);
  color: var(--text); font-family: 'DM Mono', monospace; font-size: .78rem;
  padding: 10px 22px; border-radius: 8px;
  opacity: 0; transition: opacity .25s; pointer-events: none; z-index: 999;
}
#toast.show { opacity: 1; }
#toast.err  { border-color: var(--red); color: var(--red); }

@media (max-width: 700px) {
  #podium { flex-direction: column; align-items: center; }
  .podium-card { width: 90% !important; max-width: 300px; order: unset !important; margin-top: 0 !important; }
  .list-matches { display: none; }
}
</style>
</head>
<body>
<div class="wrapper">

  <header>
    <div class="logo-block">
      <div class="logo-eyebrow">Season 16</div>
      <div class="logo-title">Team AWA Tracker</div>
    </div>
    <div class="header-meta">
      <div class="live-dot"><div class="dot"></div>En directo</div>
      <div id="countdown">—</div>
      <button class="btn-refresh" id="btn-refresh" onclick="manualRefresh()">↻ Actualizar</button>
      <button class="btn-matches" id="btn-matches" onclick="loadNewMatches()">↓ Cargar partidas</button>
    </div>
  </header>

  <div id="status-bar">
    <div class="status-line"></div>
    <span id="last-updated">cargando...</span>
    <div class="status-line"></div>
  </div>

  <div class="list-label" id="list-label" style="display:block">CLASIFICACIÓN</div>
  <div id="podium"></div>
  <div id="list"></div>

</div>
<div id="toast"></div>

<script>
// ════════════════════════════════════════════════════════════════
//  ★  CONFIGURA AQUÍ  ★
// ════════════════════════════════════════════════════════════════
const PLAYERS = [
  { name: "DDR4 2x16GB 3600", tag: "pepi" },
  { name: "LaDragonaTragona",  tag: "AWA" },
  { name: "lil yowi",  tag: "TS13" },
  { name: "lil aitor",  tag: "EUW" },
  { name: "comehigados",  tag: "EUW" },
];

const API        = "/api/riot";
const DDRAGON_V  = "15.1.1";
const MAX_MATCHES = 3;          // partidas que se muestran por jugador
const DELAY_MS   = 200;         // ms entre llamadas para no petar el rate limit
const ICON = id => `https://ddragon.leagueoflegends.com/cdn/${DDRAGON_V}/img/profileicon/${id}.png`;
// ════════════════════════════════════════════════════════════════

// ── CACHE en localStorage ─────────────────────────────────────
// matchCache:  { matchId → { win, champ, k, d, a } }
// knownIds:    { puuid  → [matchId, ...] }          (últimos conocidos)
function loadCache(key) {
  try { return JSON.parse(localStorage.getItem(key) || "{}"); } catch { return {}; }
}
function saveCache(key, data) {
  try { localStorage.setItem(key, JSON.stringify(data)); } catch {}
}

let matchCache = loadCache("awa_matches_v1");   // detalles de partida
let knownIds   = loadCache("awa_known_ids_v1"); // matchIds que ya tenemos

// ── STATE ─────────────────────────────────────────────────────
let state = {};   // playerKey → { gameName, tagLine, puuid, profileIconId, summonerLevel, data, lastUpdate }
let cdSecs = 3600, cdTimer = null;

const TIER_ORDER = { IRON:0,BRONZE:1,SILVER:2,GOLD:3,PLATINUM:4,EMERALD:5,DIAMOND:6,MASTER:7,GRANDMASTER:8,CHALLENGER:9 };
const RANK_ORDER = { IV:0,III:1,II:2,I:3 };

function rankScore(rankData) {
  const s = rankData?.find(r => r.queueType === "RANKED_SOLO_5x5");
  if (!s) return -1;
  return (TIER_ORDER[s.tier]??-1)*10000 + (RANK_ORDER[s.rank]??0)*1000 + (s.leaguePoints||0);
}

// ── INIT ──────────────────────────────────────────────────────
(async function init() {
  renderLoadingState();
  startCountdown();
  await fetchBaseData();
  await autoRefresh();   // primera carga completa (rank + live + matchIds, no detalles)
})();

// ── BASE DATA: account + summoner (solo al cargar) ────────────
async function fetchBaseData() {
  for (const p of PLAYERS) {
    const key = playerKey(p);
    try {
      const acc = await api(`/account/${enc(p.name)}/${enc(p.tag)}`);
      await sleep(DELAY_MS);
      const sum = await api(`/summoner/${acc.puuid}`);
      await sleep(DELAY_MS);
      state[key] = {
        gameName: acc.gameName, tagLine: acc.tagLine,
        puuid: acc.puuid,
        profileIconId: sum.profileIconId,
        summonerLevel: sum.summonerLevel,
        data: null, lastUpdate: null
      };
    } catch(e) {
      state[key] = { gameName: p.name, tagLine: p.tag, error: true };
    }
  }
}

// ── AUTO REFRESH (cada hora): rank + live + matchIds ──────────
// NO descarga detalles de partidas nuevas automáticamente
async function autoRefresh() {
  setButtons(true);
  for (const p of PLAYERS) {
    await refreshPlayerLight(playerKey(p));
    await sleep(DELAY_MS);
  }
  document.getElementById("last-updated").textContent =
    "última actualización: " + new Date().toLocaleTimeString("es-ES");
  resetCountdown();
  renderEverything();
  setButtons(false);
}

// ── MANUAL REFRESH (botón): igual que autoRefresh ─────────────
async function manualRefresh() {
  toast("Actualizando...");
  await autoRefresh();
  toast("Actualizado ✓");
}

// ── LIGHT REFRESH: rank + live + matchIds (sin detalles) ──────
async function refreshPlayerLight(key) {
  const p = state[key];
  if (!p || p.error) return;
  try {
    const [rankData, liveData, matchIds] = await Promise.all([
      api(`/rank/${p.puuid}`),
      api(`/live/${p.puuid}`),
      api(`/matches/${p.puuid}?count=${MAX_MATCHES}`)
    ]);

    // Guarda los matchIds conocidos para este jugador
    knownIds[p.puuid] = matchIds;
    saveCache("awa_known_ids_v1", knownIds);

    // Reconstruye recentMatches desde cache (solo los que ya tenemos descargados)
    const recentMatches = matchIds
      .slice(0, MAX_MATCHES)
      .map(id => matchCache[id] || null)
      .filter(Boolean);

    state[key] = {
      ...p,
      data: { rankData, inGame: !!liveData.gameId, recentMatches, matchIds },
      lastUpdate: Date.now()
    };
  } catch(e) {
    console.warn("Error refresh light", key, e);
  }
}

// ── LOAD NEW MATCHES (botón): descarga detalles de partidas nuevas ──
async function loadNewMatches() {
  setButtons(true);
  toast("Buscando partidas nuevas...");

  let downloaded = 0;

  for (const p of PLAYERS) {
    const key  = playerKey(p);
    const ps   = state[key];
    if (!ps || ps.error || !ps.data?.matchIds) continue;

    const newIds = ps.data.matchIds.filter(id => !matchCache[id]);
    if (newIds.length === 0) continue;

    for (const id of newIds) {
      try {
        const m = await api(`/match/${id}`);
        const me = m.info.participants.find(x => x.puuid === ps.puuid);
        if (me) {
          matchCache[id] = {
            win: me.win, champ: me.championName,
            k: me.kills, d: me.deaths, a: me.assists
          };
          downloaded++;
        }
        await sleep(DELAY_MS);
      } catch(e) {
        console.warn("Error fetching match", id, e);
        await sleep(500); // si falla, espera más antes del siguiente
      }
    }

    // Actualiza el state con las nuevas partidas
    const recentMatches = ps.data.matchIds
      .slice(0, MAX_MATCHES)
      .map(id => matchCache[id] || null)
      .filter(Boolean);

    state[key] = { ...ps, data: { ...ps.data, recentMatches } };
  }

  saveCache("awa_matches_v1", matchCache);
  renderEverything();
  setButtons(false);

  if (downloaded > 0) {
    toast(`${downloaded} partida${downloaded>1?"s":""} nueva${downloaded>1?"s":""} cargada${downloaded>1?"s":""} ✓`);
  } else {
    toast("Sin partidas nuevas");
  }
}

// ── RENDER ────────────────────────────────────────────────────
function sortedPlayers() {
  return PLAYERS
    .map(p => state[playerKey(p)] || { gameName: p.name, tagLine: p.tag, error: true })
    .sort((a,b) => rankScore(b.data?.rankData) - rankScore(a.data?.rankData));
}

function renderEverything() {
  const sorted = sortedPlayers();
  renderPodium(sorted.slice(0,3));
  const rest = sorted.slice(3);
  const listEl    = document.getElementById("list");
  const listLabel = document.getElementById("list-label");
  listEl.innerHTML = "";
  if (rest.length > 0) {
    listLabel.style.display = "block";
    rest.forEach((p, i) => listEl.insertAdjacentHTML("beforeend", buildListRow(p, i+4)));
  } else {
    listLabel.style.display = "none";
  }
}

function renderLoadingState() {
  document.getElementById("list-label").style.display = "block";
  document.getElementById("podium").innerHTML = `
    <div class="podium-card p2" style="animation-delay:.1s">
      <div class="medal">2º</div>
      <div style="width:66px;height:66px;border-radius:50%;margin-bottom:14px" class="skel"></div>
      <div class="skel" style="height:16px;width:80%;margin-bottom:6px"></div>
      <div class="skel" style="height:11px;width:50%;margin-bottom:14px"></div>
      <div class="skel" style="height:22px;width:70%"></div>
    </div>
    <div class="podium-card p1" style="animation-delay:0s">
      <div class="medal">1º</div>
      <div style="width:82px;height:82px;border-radius:50%;margin-bottom:14px" class="skel"></div>
      <div class="skel" style="height:20px;width:80%;margin-bottom:6px"></div>
      <div class="skel" style="height:12px;width:50%;margin-bottom:14px"></div>
      <div class="skel" style="height:26px;width:70%"></div>
    </div>
    <div class="podium-card p3" style="animation-delay:.2s">
      <div class="medal">3º</div>
      <div style="width:66px;height:66px;border-radius:50%;margin-bottom:14px" class="skel"></div>
      <div class="skel" style="height:16px;width:80%;margin-bottom:6px"></div>
      <div class="skel" style="height:11px;width:50%;margin-bottom:14px"></div>
      <div class="skel" style="height:22px;width:70%"></div>
    </div>`;
}

function renderPodium(top3) {
  const podium = document.getElementById("podium");
  podium.innerHTML = "";
  const slots = [
    { p: top3[1], cls: "p2", label: "2º", delay: ".1s" },
    { p: top3[0], cls: "p1", label: "1º", delay: "0s"  },
    { p: top3[2], cls: "p3", label: "3º", delay: ".2s" },
  ];
  slots.forEach(({ p, cls, label, delay }) => {
    if (!p) return;
    podium.insertAdjacentHTML("beforeend", buildPodiumCard(p, cls, label, delay));
  });
}

function buildPodiumCard(p, cls, label, delay) {
  const d      = p.data;
  const soloQ  = d?.rankData?.find(r => r.queueType === "RANKED_SOLO_5x5");
  const inGame = d?.inGame;
  const tierCls = soloQ ? "t-"+soloQ.tier.toLowerCase() : "t-unranked";
  const tierStr = soloQ ? `${soloQ.tier} ${soloQ.rank}` : "Unranked";
  const lpStr   = soloQ ? `${soloQ.leaguePoints} LP` : "—";
  const wr      = soloQ ? Math.round(soloQ.wins/(soloQ.wins+soloQ.losses)*100) : null;
  const wrStr   = wr !== null ? `${wr}% WR` : "";
  const wrCls   = wr !== null ? (wr>=50?"wr-w":"wr-l") : "";
  const matchesHTML = buildPodiumMatches(p, d?.matchIds);

  return `
    <div class="podium-card ${cls}${inGame?" in-game":""}" style="animation-delay:${delay}">
      <div class="medal">${label}</div>
      <div class="p-avatar-ring">
        <img class="p-avatar" src="${ICON(p.profileIconId||29)}" onerror="this.src='${ICON(29)}'"/>
        <div class="p-lvl">${p.summonerLevel||"?"}</div>
      </div>
      <div class="p-name">${p.gameName}</div>
      <div class="p-tag">#${p.tagLine}</div>
      ${d ? `
        <div class="p-rank ${tierCls}">${tierStr}</div>
        <div class="p-lp">${lpStr}</div>
        <div class="p-wr ${wrCls}">${wrStr}</div>
      ` : `<div class="skel" style="height:20px;width:80%;margin:6px auto"></div>`}
      <div class="p-ingame ${inGame?"live":"idle"}">${inGame?"● IN GAME":"· offline"}</div>
      ${matchesHTML}
    </div>`;
}

function buildPodiumMatches(p, matchIds) {
  const matches = p.data?.recentMatches;
  if (!matches?.length) {
    // Si hay matchIds pero sin detalles, muestra placeholder
    if (matchIds?.length) return `<div style="font-family:'DM Mono',monospace;font-size:.55rem;color:var(--muted);margin-top:10px">↓ cargar partidas</div>`;
    return "";
  }
  const cells = matches.slice(0, MAX_MATCHES).map((m, i) => {
    const isNew = matchIds && matchIds[i] && !wasKnownBefore(matchIds[i], p.puuid);
    return `
      <div class="p-match-cell">
        <div class="p-match-strip ${m.win?"w":"l"}${isNew?" is-new":""}"></div>
        <div class="p-match-champ">${m.champ}</div>
        <div class="p-match-kda ${m.win?"w":"l"}">${m.k}/${m.d}/${m.a}</div>
      </div>`;
  }).join("");
  return `<div class="p-matches">${cells}</div>`;
}

function buildListRow(p, pos) {
  if (p.error) return `
    <div class="list-row">
      <div class="list-pos">${pos}</div>
      <div style="font-family:'DM Mono',monospace;font-size:.8rem;color:var(--red)">✕ ${p.gameName}#${p.tagLine}</div>
    </div>`;

  const d      = p.data;
  const soloQ  = d?.rankData?.find(r => r.queueType === "RANKED_SOLO_5x5");
  const inGame = d?.inGame;
  const tierCls = soloQ ? "t-"+soloQ.tier.toLowerCase() : "t-unranked";
  const tierStr = soloQ ? `${soloQ.tier} ${soloQ.rank}` : "Unranked";
  const lpStr   = soloQ ? `${soloQ.leaguePoints} LP` : "";
  const wr      = soloQ ? Math.round(soloQ.wins/(soloQ.wins+soloQ.losses)*100) : null;
  const wrStr   = wr !== null ? `${wr}% WR` : "";
  const wrCls   = wr !== null ? (wr>=50?"wr-w":"wr-l") : "";

  const matchesHTML = d?.recentMatches?.slice(0, MAX_MATCHES).map((m, i) => {
    const isNew = d.matchIds && d.matchIds[i] && !wasKnownBefore(d.matchIds[i], p.puuid);
    return `
      <div class="list-match-pip">
        <div class="list-match-strip ${m.win?"w":"l"}${isNew?" is-new":""}"></div>
        <div class="list-match-champ">${m.champ}</div>
      </div>`;
  }).join("") || "";

  return `
    <div class="list-row${inGame?" in-game":""}">
      <div class="list-pos">${pos}</div>
      <div class="list-avatar-wrap">
        <img class="list-avatar" src="${ICON(p.profileIconId||29)}" onerror="this.src='${ICON(29)}'"/>
        <div class="list-lvl">${p.summonerLevel||"?"}</div>
      </div>
      <div class="list-name-block">
        <div class="list-name">${p.gameName}</div>
        <div class="list-tag">#${p.tagLine}</div>
      </div>
      ${matchesHTML ? `<div class="list-matches">${matchesHTML}</div>` : ""}
      <div class="list-rank-block">
        <div class="list-tier ${tierCls}">${tierStr}</div>
        <div class="list-lp">${lpStr}</div>
        <div class="list-wr ${wrCls}">${wrStr}</div>
      </div>
      <div class="list-ingame ${inGame?"live":"idle"}">${inGame?"● IN GAME":"· offline"}</div>
    </div>`;
}

// ── COUNTDOWN ─────────────────────────────────────────────────
function startCountdown() {
  clearInterval(cdTimer);
  cdTimer = setInterval(async () => {
    cdSecs--;
    const h = Math.floor(cdSecs/3600);
    const m = Math.floor((cdSecs%3600)/60);
    const s = String(cdSecs%60).padStart(2,"0");
    document.getElementById("countdown").textContent =
      h > 0 ? `refresh en ${h}h ${m}m` : `refresh en ${m}:${s}`;
    if (cdSecs <= 0) await autoRefresh();
  }, 1000);
}
function resetCountdown() { cdSecs = 3600; startCountdown(); }

// ── HELPERS ───────────────────────────────────────────────────
function playerKey(p) { return `${p.name.toLowerCase()}#${p.tag.toLowerCase()}`; }
function enc(s) { return encodeURIComponent(s); }
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function setButtons(disabled) {
  document.getElementById("btn-refresh").disabled  = disabled;
  document.getElementById("btn-matches").disabled  = disabled;
}

// Para detectar si una partida es nueva (no estaba en la sesión anterior)
// Simplificado: si no estaba en el cache antes de esta sesión, es nueva
const _sessionStart = Date.now();
function wasKnownBefore(matchId) {
  // Si está en el cache, lo teníamos de antes
  return !!matchCache[matchId];
}

async function api(path) {
  const [p, qs] = path.split("?");
  const url = API + `?path=${enc(p)}` + (qs ? `&qs=${enc(qs)}` : "");
  const r = await fetch(url);
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

function toast(msg, err=false) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.className = "show"+(err?" err":"");
  clearTimeout(t._t);
  t._t = setTimeout(()=>t.className="", 3500);
}
</script>
</body>
</html>